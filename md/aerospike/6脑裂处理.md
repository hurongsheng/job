### 脑裂处理

#### 强一致性模型
![ss](https://www.aerospike.com/docs/architecture/assets/c_fig_21.png '')

- 脑裂会产生子集群a和子集群b
- 超过半数以上节点的子集群具有主副本和副本的分区，则在活跃状态
- 刚好是一半节点的集群，具有主副本的分区在活跃状态

#### 名词
roster-replica
roster-replica refers to the node that would house the replica of this partition if all nodes in the roster were part of the single cluster
roster-master
roster-master refers to the node that would house the master of this partition if all nodes in the roster were part of the single cluster

#### 节点丢失
滚动升级具有100％的可用性：如果子集群的丢失节点数少于复制因子数，则该子集群称为超级多数子集群，并且所有分区对于集群内的读/写都是活动的。

双向裂脑的100％可用性：如果系统正好拆分为两个子集群，则所有分区均处于活动状态，可以在一个或另一个子集群中进行读写操作（稍后我们将展示如何以创造性的方式使用它 用于基于机架的HA架构）。

主副本节点丢失后，副本会成为主副本，副本对应的节点会成为副本的副本

#### 节点升级

![a](https://www.aerospike.com/docs/architecture/assets/c_fig_26.png '')
在具有五个节点A，B，C，D，E的群集中，让我们考虑分区q，其中节点A为名册主服务器，节点B为名册副本。让我们考虑一次升级，其中一次删除一个节点。最初，节点A和B作为q的完整分区开始。卸下节点A后，名册副本的节点B升级为q的备用主服务器，而节点C变为q的备用副本。节点C的分区q副本现在是一个子集。成功完成软件升级后，足够快的节点A重新加入群集（作为子集），并且节点B现在掉线以进行升级。在这一点上，没有足够的时间让名册主文件A完成与B的所有数据同步（即已满）。因此，剩下的节点A是花名册主节点，它是分区q的子集，而节点C是q的另一个子集。此时，因为这是一个超级集群，所以我们可以保证在集群的所有节点中，对分区的所有更新都是可用的。这是因为每次更新都必须写入至少两个节点（复制因子2），并且在任何一次最多只能关闭一个节点。所有更改必须仍然在这些节点之一中。但是，这意味着对于所有读入A（名册主）的记录，每个请求都必须使用存储在节点C中的分区子集逐条记录地解决自身。这将暂时产生额外的开销阅读。由于Aerospike始终都写入两个副本，因此写入开销从未增加。
![a](shartdown.jpg '')
此时如果主副都关闭，备用副本节点将不可用

#### 强一致性读 Strong Consistency for reads

    读取总是发送到主分区
    如果在脑裂过程中，碰到多个分区认为自己是主分区，那么会依据最近更新时间来选择
    
#### 节点分离

Aerospike为分区添加了一种体制概念。每当分区的主切换发生时，该状态就会增加。只有旧的母版使用较早的版本，而所有写入新母版的版本都将使用下一个版本。这意味着，通过与数据处于活动状态的新子群集的较大状态编号进行比较，可以丢弃对尚未处理群集更改的主节点上的分区所做的更改。

记录最后更新时间（LUT）的40位

6位分区机制
10位记录生成

#### 线性化读取
基于上述内容，为了使服务器上的读取线性化，对主分区的每次读取都需要验证密钥所在分区的分区机制是否同步。 如果制度同意，则保证阅读是最新的。 如果制度不同意，则意味着集群更改可能正在进行中，重做/重试来自客户端的读取很重要。 因此，对于每次写入，要写入的分区的所有副本也必须具有相同的机制。

#### 会话/顺序一致性 Session/Sequential Consistency
    
      没懂
       
#### 宽松的一致性 Relaxed Consistency

还有两个宽松的一致性客户端策略：“allow replica”和“allow unavailable”。

使用宽松一致性模式，客户端将继续读取已提交的记录，但读取将不再严格单调。
     
在实践中，很难遇到“允许复制”策略违反会话一致性的情况。此策略意味着使用“强一致性”的应用程序不会看到读取超时，否则在节点（或机架）发生故障时可能会发生读取超时。此外，它使客户端能够使用“首选机架”策略，该策略通常用于减少各种云环境中的跨区域网络利用率。
     
“允许不可用”策略通过允许客户端读取标记为不可用的分区上以前提交的记录，进一步放松了一致性。此模式允许对读取不敏感的应用程序在主要网络/集群中断期间继续运行。当分区可用时，此策略的行为与“允许副本”完全相同。
